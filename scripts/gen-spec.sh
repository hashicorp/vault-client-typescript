#!/usr/bin/env bash
# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: BUSL-1.1

# This script generates the OpenAPI spec for Vault Enterprise and moves it to the vault-client-typescript root directory.
# The spec is generated by executing the `gen_openapi.sh` script located in the `scripts` directory of Vault (or Vault Enterprise).
# VAULT_DIR environment variable must be set to the absolute path of the Vault directory.

# exit if a command fails
set -e

# check if VAULT_DIR is defined
if [ -z "$VAULT_DIR" ]; then
  echo "VAULT_DIR environment variable is not defined"
  echo "Please export or set VAULT_DIR to the absolute path of the vault directory and try again"
  exit 1
fi

# check if vault version contains +ent
VERSION=$(vault version)
if [[ ! "$VERSION" == *"+ent"* ]]; then
  echo "Vault Enterprise binary not found and is required to generate the complete API client"
  echo $VERSION
  echo "Run 'make entdev' in vault-enterprise directory to build the binary and try again"
  exit 1
fi

# scripts directory
SCRIPTS_DIR="$VAULT_DIR/scripts"

# cleanup to remove the generated openapi.json file on exit
cleanup() {
  [ -n "$SCRIPTS_DIR" ] && rm -f "$SCRIPTS_DIR/openapi.json"
}
trap 'cleanup' INT TERM EXIT

echo "Generating OpenAPI spec..."
echo

# execute gen_openapi.sh in VAULT_DIR/scripts
"$SCRIPTS_DIR"/gen_openapi.sh -p
echo
echo "OpenAPI spec generated successfully!"

# move the generated openapi spec file from Vault to the vault-client-typescript root
echo "Moving OpenAPI spec from Vault to vault-client-typescript root directory..."
mv "$SCRIPTS_DIR/openapi.json" "./openapi.json"


echo "OpenAPI spec moved successfully!"
echo "You can now run 'yarn gen-client' to generate the typescript client from the OpenAPI spec."